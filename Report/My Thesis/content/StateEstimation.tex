\chapter{Zonotope-based guaranteed state estimation} \label{ch:state_estimation}
State estimation algorithms can be broadly classified into two types: Stochastic and Set-based algorithms. Stochastic state estimation algorithms assume that the uncertainties in the state of the system follow a known probability distribution. It is difficult to fulfill the assumption for such algorithms, however, Zorzi \cite{Zorzi2017} proposed a family of Kalman filters that solves the minimax problem with an iterative probability distribution of the uncertainties.

Set-based algorithms, on the other hand, utilize geometrical sets as domain representation, like ellipsoid or zonotope, to bound the possible sets of state of the system. Zonotopes are better than ellipsoids due to the balance of accuracy and computational cost. Furthermore, zonotopes can control the wrapping effect \cite{Kuhn1998}, which is the term referred to the growth of the estimated state due to the propagated uncertainties in each iteration. In addition, the sum of zonotopes is also a zonotope (Minkowski sum), which is a desirable property for the techniques.

Set-based algorithms can be further classified into segment intersection and interval observer. The former methods focus on intersecting the set of estimated state with the set of predicted state from the measurements. These methods try to minimize the bounds of the estimated state by using different properties, like volume and radius, of the geometric set. The interval observer methods, on the other hand, design observer to minimize the error on each time step. The following sections dig deeper into each of the aforementioned methods.

\section{Segment Intersection} 
\begin{equation}
\label{formula:system_segint}
\begin{split}
x_{k+1} &= Ax_k + Ew_k\\
y_k &= Cx_k + Fv_k
\end{split}
\end{equation}
For the system in \eqref{formula:system_segint}, let the set of predicted state of the system at time $k$ be denoted by a zonotope, $\overline{\mathcal{X}_k} = p\bigoplus H \textbf{B}^r$. The set to represent the $i^{th}$ state in measurement($y_{k/i}$) at time $k$ is a strip, denoted by $\mathscr{S}_i = \{x \in \mathbb{R} : |C_i x - y_{k/i}| \leq v_{k/i}\}$ \footnote{$C_i$ is the $i^{th}$ row of $C$}. The estimation at time $k$, denoted by $\mathcal{\hat{X}}_k$, is the intersection of the strip, $\mathscr{S}$, and the zonotope $\overline{\mathcal{X}_k}$, which can be parametrized by a vector $\lambda_i \in \mathbb{R}^n$ such that \eqref{formula:lambda}. 
\begin{equation}
\label{formula:lambda}
\begin{split}
\mathcal{\hat{X}}_{k/i} &= \hat{p}(\lambda_i) + \hat{H}(\lambda_i)\textbf{B}^{r+1}  \\
where \quad \hat{p}(\lambda_i) &= p+ \lambda_i(y_{k/i} - C_ip)\\
and \quad \hat{H}(\lambda_i) &= [(I- \lambda_i C_i) H \quad v_{k/i}\lambda_i ]
\end{split}
\end{equation}
The motive of segment intersection methods is to find the value of $\lambda$ such that the intersected segment is compact. For every iteration, the order of the zonotope increases, and hence to reduce accumulating compuation burden, the estimated zonotope is reduced to maximum order of 20 for this paper using the reduction function in CORA. In the following sections, we briefly discuss three different approaches to solve $\lambda$ that parametrizes the minimum intersected zonotope by focusing on three distinguishing properties of zonotope.

\subsection{Frobenius norm of generators}
This algorithm solves the problem by minimizing the F-norm of the generators of the intersected zonotope. Let us rewrite $\hat{H}(\lambda)$ as $A+ \lambda b^T$ such that $A= [H \quad 0]$ and $b^T = [-C_i H \quad v_{k/i}]$.

Thus, the Frobenius norm of the generators of a zonotope is calculated using the formula \eqref{fnormformula}\cite{Alamo2005}.
\begin{equation}
\label{fnormformula}
\begin{split}
||H||_{F}^2 & = ||A + \lambda b^T||^{2}_F \\
&= 2\lambda^T A b+ (b^Tb)\lambda^T\lambda + tr(A^TA)
\end{split}
\end{equation}

\begin{equation}
\label{lambdaformula}
\lambda^* = \frac{-Ab }{b^Tb}  = \frac{HH^TC_i^T}{C_i HH^TC_i^T} + v_{k/i}^2
\end{equation}

The $\lambda^*$ that corresponds to the minimum Frobenius norm of the generators of the intersected zonotope is calculated using the formula \eqref{lambdaformula} for each measurement in each iteration and the minimum zonotope to represent the estimation is calculated.


\begin{algorithm}
		
        \caption{Estimation by minimizing F-norm of intersected segment}
        \textbf{Input:} $y_k$\\
 		\textbf{Output:} $\overline{x_k}$, $\underline{x_k}$
        \begin{algorithmic}[1]
        \State $\langle p,H \rangle$ $\gets$ $\mathcal{X}$
        \For{$j$ $\gets$ $0$ to $n_y$}
        	\State $\lambda$ $\gets$ \Call{calculate\_lambda}{$H, C_j, V_j$}
        	\State $p$ $\gets$ $p + \lambda (y_{k/j} - C_j p)$
        	\State $H$ $\gets$ $[(I- \lambda C_j)H \quad V_j\lambda]$ 
        \EndFor
        \State $\mathcal{X}$ $\gets$ $\langle p, H \rangle$
        \State $[\overline{x_k}, \underline{x_k}]$ $\gets$ \Call{interval}{$\mathcal{X}$}
        \State $\mathcal{X}$ $\gets$ $\mathcal{X}_{\downarrow m}$
        \end{algorithmic}
        \label{alg:fnorm}
\end{algorithm}
\subsection{Volume}
Volume is a precise metric directly proportional to the size of the zonotope. The volume of the $\mathcal{\hat{X}}_k$ for $i^{th}$ measurement state is \cite{Alamo2005}:
\begin{equation}
\label{volumeformula}
\begin{split}
Vol(\hat{X}(\lambda))=& 2^n \sum^{N(n,r)}_{j=1} |[(I - \lambda C_i)det(A_j)|\\
&+ 2^n \sum^{N(n-1,r)}_{j=1} \sigma|det[(I- \lambda C_i)B_j\quad v_k/i\lambda]|
\end{split}
\end{equation}
where $N(n,r)$ denotes the number of combinations of $r$ elements from a set of $n$ elements, $A_j$ and $B_j$ denote each of the different matrices generated by choosing $n$ and $n-1$ columns from $H$ respectively. 

For this paper, the \texttt{zonotope.volume} function provided by CORA is used along with \texttt{fmincon} solver in Matlab\textsuperscript{\tiny\textregistered} to find the value of $\lambda$ corresponding to the minimum volume of the intersected zonotope. Although volume minimizes the intersected zonotope significantly, the calculation of volume is extremely computationally heavy. Therefore, it works best for use-cases that are not time-sensitive, e.g. fault diagnosis and fault-tolerant control systems \cite{Puig2010}. 
\subsection{P-radius}
The P-radius of a zonotope can be calculated with the formula \eqref{pradformula} where $P$ is a positive definite matrix \cite{Alamo2005}.
\begin{equation}
\label{pradformula}
\underset{z \in Z}{max} (||z - p||^2_{P}) = \underset{z \in Z}{max}((z-p)^T P (z-p))
\end{equation}
To make sure the P-radius does not increase in every iteration, $\lambda$ can be computed off-line by solving the LMI(Linear Matrix Inequality) in Equation \eqref{eq:pradlmi} using Mosek solver in Matlab\textsuperscript{\tiny\textregistered}.
\begin{equation}
\label{eq:pradlmi}
\left[
\begin{matrix}
\beta & P & 0 & A^TP - A^TC_iY^T\\
* & F^TF & 0 & F^TP -F^TC_iY^T\\
* & * & v_k/i ^2 & Y^Tv_k/i\\
* & * & * & P
\end{matrix}\right] \succeq 0,
where\quad Y = P\lambda_i
\end{equation}

Due to off-line computation, this method is substantially faster and has been used in lower accuracy-prone systems like secure monitoring of cyber-physical systems against attacks \cite{GE20201592}.

\section{Interval Observer}
Interval observers need to design observers to minimize the error in the estimation. For the system in \eqref{formula:system_segint}, \eqref{formula:observer} defines the observer, where $L$ is the observer gain to be designed. The design of such observers is not very easy. The following section discusses about a method, which uses H-$\infty$ observer design.
\begin{equation}
\label{formula:observer}
x_{k+1} = Ax_k + L(y_k -Cx_k)
\end{equation}

\subsection{H-$\infty$ Observer}
The interval observer, proposed in \cite{Tang2019}, designs the observer gain to minimize the estimation error in each step by using the observer gain as $L= P^{-1}Y$ with $P$, a positive definite matrix with dimension $n_x \times n_x$, and $Y$, a matrix with dimension $n_x \times n_y$, both solution to the optimization problem in \eqref{eq:optimizationprob}.
\begin{equation}
\label{eq:optimizationprob}
\underset{\gamma _2}{min} \;
s.t. \; \eqref{LMI}
\end{equation} 
\begin{equation}
\label{LMI}
\left[\begin{matrix}
I_{n_x} -P & * & * & *\\
0 & -\gamma ^2 I_{n_w} & * &* \\
0 & 0 & -\gamma ^2 I_{n_v} & *\\
PA-YC & PE & -YF & -P
\end{matrix}\right]  \prec 0
\end{equation} 

With $L$ derived using a Mosek solver in Matlab\textsuperscript{\tiny\textregistered}, the estimator is initialized with a $model$ and the following parameters\\
\begin{equation}
\begin{split}
\mathcal{W} = \langle 0, H_w\rangle,& \quad \mathcal{V} = \langle 0,H_v\rangle\\
D_w = E\mathcal{W}, & \quad D_v = -LF\mathcal{V}\\
S_x= \langle 0, H_0\rangle, &\quad S_w = \emptyset,\quad S_v = \emptyset
\end{split}
\end{equation}
where $H_w = diag(\overline{w})$ and $H_v= diag(\overline{v})$

For every measurement, $y$, the estimator estimates using the Alg.~\ref{alg:h_infinity}.
\begin{algorithm}
		
        \caption{Estimation using H-$\infty$ interval observer}
        \textbf{Input} $y$\\
 		\textbf{Output} $\overline{x}$, $\underline{x}$
        \begin{algorithmic}[1]
        \State $[\overline{e}, \underline{e}]$ $\gets$ \Call{interval}{$S_x$}$\bigoplus S_w \bigoplus S_v$ \label{alg:main_constraints}
        \State $\overline{x}$ $\gets$ $\hat{x} + \overline{e}$
        \State $\underline{x}$ $\gets$ $\hat{x} + \underline{e}$
        \State $\hat{x}$ $\gets$ $A\hat{x} + L(y- C\hat{x})$ \label{alg:main_reac}
        \State $S_x$ $\gets$ $(A-LC)S_x$
        \State $S_w$ $\gets$ $S_w \bigoplus$ \Call{interval}{$D_w$}
        \State $S_v$ $\gets$ $S_v \bigoplus$ \Call{interval}{$D_v$}
        \State $D_w$ $\gets$ $(A-LC)D_w$
        \State $D_v$ $\gets$ $(A-LC)D_v$
        \end{algorithmic}
        \label{alg:h_infinity}
\end{algorithm}



